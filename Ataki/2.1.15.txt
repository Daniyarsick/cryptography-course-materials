# Аннануров Даниил 3 курс
# Атака "зашифровать и подписать"

with(numtheory):
with(RandomTools):

# Генерация ключей пользователя B (получатель)
pb:= nextprime(Generate(integer(range=3..10^3)));
qb:= nextprime(Generate(integer(range=3..10^3)));
nb:=pb*qb;							# открытый модуль B
eb:= prevprime(phi(nb)); db:= eb&^(-1) mod phi(nb);	# ключи B

# Генерация ключей пользователя A (отправитель)
pa:= nextprime(Generate(integer(range=pb..10^3)));
qa:= nextprime(Generate(integer(range=qb..10^3)));
na:=pa*qa;							# открытый модуль A
ea:= prevprime(phi(na));			# открытый ключ A
da:=ea&^(-1) mod phi(na);			# секретный ключ A

# Процедура "зашифровать и подписать" (уязвимая)
m:=1234;							# исходное сообщение
m1:=m&^eb mod nb;  					# зашифровать открытым ключом B
s:= m1&^da mod na;  				# подписать секретным ключом A

# Процедура проверки и расшифровки
meb:= s&^ea mod na;					# проверка подписи открытым ключом A
m2:= meb&^db mod nb;				# расшифровка секретным ключом B

# Проверка корректности передачи
m-m2;

# Криптоанализ: атака на схему "зашифровать и подписать"
x:=mlog(m, m1, nb);					# поиск дискретного логарифма
e1b:= x*eb;						# модифицированная экспонента
d1b:= e1b&^(-1) mod nb;				# соответствующий секретный ключ
m3:= m1&^e1b mod nb;				# повторное шифрование
s1:= m3&^da mod na;					# подпись модифицированного текста

# Проверка успешности атаки
s1 - s;