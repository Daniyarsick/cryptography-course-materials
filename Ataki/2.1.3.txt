# Аннануров Даниил 3 курс
# Атака с помощью разложения на множители методом Ферма

with(numtheory):
with(RandomTools):

# Генерация близких по значению простых чисел (уязвимость для метода Ферма)
# Генерация двух простых чисел p и q(близкое к p)
p:= nextprime(Generate(integer(range=3..10^10))):
q:= nextprime(Generate(integer(range=p..p+10000000))):

# Формирование открытого ключа
# Вычисляем произведение (это открытый ключ RSA)
N:=p*q;

# Криптоанализ: метод факторизации Ферма
# Вычисляем среднее арифметическое p и q
x:= (p+q)/2;
y:= (q-p)/2;

# Инициализация переменных для алгоритма Ферма
k:= 1 + floor(N^(1/2)); y:=k^2 - N; d:=1;
# Поиск представления N в виде разности квадратов
while not issqr(y) do
 y:= y+2*k+d;
 d:=d+2;
end do:
# Вычисление найденных корней
x:=sqrt(N+y);
y:= sqrt(y);

# Восстановление простых множителей
# Находим множители по формулам:
p1:=x-y; q1:=x+y; 

# Проверка корректности факторизации
p-p1; q-q1;
